FROM lscr.io/linuxserver/webtop:4.16-r0-ls95
LABEL NAME="OWASP WrongSecrets Web Desktop" MAINTAINER="Jeroen Willemsen"

RUN \
   echo "*** install kubectl ***" && \
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" &&\
    sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl &&\
    rm kubectl

RUN \
  echo "**** install packages ****" && \
  apk add --no-cache shadow keepassxc radare2 aws-cli geany git gdb build-base icu-libs icu-data-full ca-certificates libgcc libstdc++ zlib libintl musl-locales musl-locales-lang lttng-ust libunwind libgdiplus && \
  echo "**** adding abc user to root for Docker ****" && \
  usermod -aG root abc && \
  touch /var/run/docker.sock && \
  chown abc:abc /var/run/docker.sock && \
  echo "**** cleanup ****" && \
  rm -rf /tmp/*

RUN \
  echo "installing dotnet 8.0 with comprehensive musl compatibility" && \
  apk add --no-cache curl icu-libs icu-data-full krb5-libs libgcc libintl libssl3 libstdc++ zlib \
    musl-locales musl-locales-lang tzdata ca-certificates lttng-ust libunwind libgdiplus && \
  curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin --channel 8.0 --install-dir /etc/dotnet && \
  export DOTNET_ROOT=/etc/dotnet && \
  export PATH="/etc/dotnet:/etc/dotnet/tools:$PATH" && \
  export DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=0 && \
  export DOTNET_RUNNING_IN_CONTAINER=true && \
  echo "Checking dotnet installation..." && \
  /etc/dotnet/dotnet --info && \
  echo "Installing ilspycmd..." && \
  /etc/dotnet/dotnet tool install ilspycmd --version 9.0.0.7889 --tool-path /etc/dotnet/tools

WORKDIR /config/Desktop

# Add secret handling for challenge functionality
# Create the /app directory to store the secret
RUN mkdir -p /app

# Use a separate RUN command for --mount
RUN --mount=type=secret,id=mysecret \
    export SECRET_VALUE=$(cat /run/secrets/mysecret) && \
    echo $SECRET_VALUE >> /app/secret.txt

# Create directories for copied files
RUN mkdir -p /var/tmp/wrongsecrets /var/tmp/wrongsecrets/decrypt

COPY src/main/resources/executables/*linux-mus* /var/tmp/wrongsecrets/
COPY src/main/resources/executables/decrypt/ /var/tmp/wrongsecrets/decrypt/
COPY src/main/resources/executables/wrongsecrets-advanced-c-windows.exe /var/tmp/wrongsecrets/
COPY src/main/resources/executables/secrchallenge.md /var/tmp/wrongsecrets/
COPY src/main/resources/executables/secrchallenge.json /var/tmp/wrongsecrets/
COPY src/test/resources/alibabacreds.kdbx /var/tmp/wrongsecrets/
COPY wrongsecret-desktop-resources/welcome.md /var/tmp/wrongsecrets/

COPY wrongsecret-desktop-resources/startwm.sh /defaults/startwm.sh

